name: Website Monitor

on:
  # å®šæ™‚åŸ·è¡Œ - æ¯å¤©å…©æ¬¡ï¼ˆå°ç£æ™‚é–“ 9:00 å’Œ 21:00ï¼ŒUTC 1:00 å’Œ 13:00ï¼‰
  schedule:
    - cron: '0 1,13 * * *'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Chrome/Chromium
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    - name: Install display dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-xkb-utils xfonts-100dpi xfonts-75dpi xfonts-scalable xfonts-cyrillic x11-apps
        sudo apt-get install -y dbus-x11

    - name: Run monitor check with virtual display
      env:
        MONITOR_URL: ${{ secrets.MONITOR_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        HEADLESS: false
        DISPLAY: :99
      run: |
        # å•Ÿå‹•è™›æ“¬é¡¯ç¤ºå™¨ï¼ˆXvfbï¼‰å¢å¼·é…ç½®
        echo "ğŸ–¥ï¸  å•Ÿå‹• Xvfb è™›æ“¬é¡¯ç¤ºå™¨..."
        Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
        XVFB_PID=$!
        echo "Xvfb PID: $XVFB_PID"

        # ç­‰å¾… Xvfb å•Ÿå‹•
        sleep 3

        # é©—è­‰ DISPLAY
        echo "DISPLAY=$DISPLAY"
        xdpyinfo -display :99 >/dev/null 2>&1 && echo "âœ… Xvfb å•Ÿå‹•æˆåŠŸ" || echo "âŒ Xvfb å•Ÿå‹•å¤±æ•—"

        # é‹è¡Œæª¢æ¸¬
        echo "ğŸ” é–‹å§‹é‹è¡Œæª¢æ¸¬ï¼ˆé headless æ¨¡å¼ï¼‰..."
        node check-and-save.js

        # æ¸…ç†
        kill $XVFB_PID 2>/dev/null || true

    - name: Commit and push results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/data/

        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          exit 0
        fi

        # æäº¤è®Šæ›´
        git commit -m "Update monitor results - $(date '+%Y-%m-%d %H:%M:%S')"

        # é‡è©¦æ¨é€æœ€å¤š 3 æ¬¡
        for i in {1..3}; do
          echo "å˜—è©¦æ¨é€ (ç¬¬ $i æ¬¡)..."
          if git pull --rebase && git push; then
            echo "æ¨é€æˆåŠŸï¼"
            exit 0
          fi
          echo "æ¨é€å¤±æ•—ï¼Œç­‰å¾… 5 ç§’å¾Œé‡è©¦..."
          sleep 5
        done

        echo "æ¨é€å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸"
        exit 1
